# Centralized Logging with SigNoz on Kubernetes

This repository contains the configuration and instructions to deploy SigNoz on a Kubernetes cluster for centralized logging, with support for log tagging (Namespace, Service name) and retention.

## Cluster Prerequisites

-   **Kubernetes Cluster**: Version 1.21 or higher.
-   **Helm**: Version 3.0 or higher.
-   **Resources**: SigNoz requires significant resources. Ensure your cluster has at least 4 vCPUs and 8GB RAM available for a basic deployment (ClickHouse, OTel Collector, Query Service, etc.).
-   **Storage**: A Default StorageClass is required for ClickHouse and Query Service persistence.

## 1. Deploy SigNoz

Follow these steps to deploy SigNoz using the provided `values.yaml`:

```bash
# Add SigNoz Helm repository
helm repo add signoz https://charts.signoz.io
helm repo update

# Create namespace
kubectl create namespace signoz

# Install SigNoz
helm install signoz signoz/signoz -n signoz -f k8s/signoz/values.yaml
```

## 2. Centralized Logging Configuration

The provided `k8s/signoz/values.yaml` configures the central **SigNoz OTel Collector** to:
-   **Application Logs**: Scrape logs from `/var/log/pods/*` (standard container output).
-   **Infrastructure Logs**: Scrape system logs from `/var/log/*.log` (e.g., kubelet, system daemons).
-   **Enrichment**: Add Kubernetes metadata and Host/Node information via `k8sattributes` and `resourcedetection`.
-   **Optimized for Single-Node**: This setup is perfect for tests in environments like KillerCoda.

### How it works:
-   **Namespace Tagging**: The `k8sattributes` processor extracts the namespace from the Kubernetes API or pod labels.
-   **Service Name Tagging**: SigNoz looks for the `service.name` attribute. If your pods have the label `service.name`, it will be automatically picked up.

## 3. How to Onboard a New Microservice

To ensure logs from your microservice are properly tagged and searchable in SigNoz:

1.  **Label your Pods**: Add the label `service.name` to your pod template.
2.  **Standard Labels**: SigNoz also attempts to derive service names from `app.kubernetes.io/name` or the Deployment name if `service.name` is missing.

**Example Pod Spec:**
```yaml
template:
  metadata:
    labels:
      service.name: "my-awesome-service"
```

## 4. Verification

Deploy the sample microservice to verify logging:

```bash
kubectl apply -f k8s/sample-app/service.yaml
```

1.  The SigNoz UI is configured on a static NodePort: `30080`.
2.  Access the UI at `http://<NODE_IP>:30080`.
3.  Go to the **Logs** tab.
4.  Filter by `k8s_namespace_name` = `sample-app` or `service_name` = `log-generator-service`.

## 5. Retention Policy

### Via values.yaml (Configured)
In the provided `k8s/signoz/values.yaml`, retention is set to 7 days:
```yaml
clickhouse:
  configData:
    ttl_for_logs: 7
```

### Via UI (Alternative)
1.  Go to **Settings** > **General** in the SigNoz UI.
2.  Locate the **Log Retention** section.
3.  Set the desired number of days.

### Via ClickHouse TTL (Advanced)
The retention is ultimately managed by ClickHouse TTL. You can set this in the Helm chart or by running a SQL command in ClickHouse:

```sql
ALTER TABLE signoz_logs.logs MODIFY COLUMN timestamp TTL timestamp + INTERVAL 7 DAY;
```
*(Default retention is often 30 days in SigNoz).*

## 6. Troubleshooting Missing Logs

If logs are not appearing in the SigNoz dashboard, check the following:

### 1. Agent connection to Collector
The `otelAgent` (DaemonSet) must be able to reach the `otelCollector` (Deployment).
Check the agent pods for any "connection refused" or "context deadline exceeded" errors:
```bash
kubectl logs -n signoz -l app.kubernetes.io/component=otel-agent
```

### 2. Ingestion Key (Tokens)
- **Self-Hosted (Local/KillerCoda)**: No ingestion key is required by default. The configuration I provided points the agent directly to the internal collector without authentication.
- **SigNoz Cloud**: If you are sending logs to SigNoz Cloud, you **must** provide an ingestion key. You can find this in your SigNoz Cloud dashboard under **Settings** > **Ingestion Keys**.

### 3. Service Name Tagging
Ensure your Pods have the `service.name` label. If missing, SigNoz might not categorize the logs correctly under the "Services" filter.

### 4. Namespace Filtering
Verify that the `sample-app` namespace exists and logs are being generated by the pod:
```bash
kubectl logs -n sample-app -l service.name=log-generator-service
```
