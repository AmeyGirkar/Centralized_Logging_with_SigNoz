# global -- Global override values for the chart.
global:
  storageClass: local-path

# clickhouse -- ClickHouse settings for log storage and retention.
clickhouse:
  enabled: true
  configData:
    ttl_for_logs: 7
  persistence:
    storageClass: local-path

# signoz -- SigNoz UI and Query Service settings.
signoz:
  service:
    type: NodePort
    nodePort: 30080
  persistence:
    storageClass: local-path

# otelAgent -- Configuration for the Log Scraper (DaemonSet).
otelAgent:
  enabled: true
  config:
    receivers:
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        exclude:
          - /var/log/pods/signoz_*/*/*.log
        # Automatically parse the log file path to extract namespace and pod info
        operators:
          - type: regex_parser
            regex: '^/var/log/pods/(?P<namespace>[^/]+)_(?P<pod_name>[^/]+)_(?P<uid>[a-z0-9-]+)/(?P<container_name>[^/]+)/(?P<restart_count>\d+)\.log$'
            parse_from: attributes["log.file.path"]
    
    processors:
      k8sattributes:
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.deployment.name
            - container.name
          # Explicitly tag logs with 'service.name' from Pod labels
          labels:
            - tag_name: service.name
              key: service.name
              from: pod
        passthrough: false
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: resource_attribute
                name: k8s.pod.uid
          - sources:
              - from: connection

    exporters:
      otlp:
        # Export logs to the central SigNoz Collector
        endpoint: "signoz-otel-collector.signoz.svc.cluster.local:4317"
        tls:
          insecure: true

    service:
      pipelines:
        logs:
          receivers: [filelog]
          processors: [k8sattributes, batch]
          exporters: [otlp]
